<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">  
  <link rel="stylesheet" href="../CSS/main.css">
  <link rel="stylesheet" href="../CSS/fight.css">
  <link href="https://fonts.googleapis.com/css2?family=WDXL+Lubrifont+TC&display=swap" rel="stylesheet">
  <title>Fight</title>
</head>

<body>
  <div class="upperSection">
    <p>Character</p>
    <ul class="social-links">
      <li><a href="home.html"><img class="social-links" src="../images/homeImages/house.png" alt="home"></a></li>
      <li><a href="./characters.html"><img class="social-links" src="../images/homeImages/user.png" alt="user"></a></li>
      <li><a href="./settings.html"><img class="social-links" src="../images/homeImages/setting.png" alt="settings"></a></li>
    </ul>
  </div>
  <hr>

  <div class="containerFight">

    <div class="myFighter">
      <h3 id="player-name">Player</h3>
      <img class="enemy-img" id="currentAvatar" src="../images/avatar1.png" alt="Player picture">
      <div class="health-bar">
        <div id="player-health" class="health-fill"></div>
      </div>
      <p id="player-hp-text">100 / 100</p>
    </div>

    <div class="fightUI">
      <h2>Choose Your Attack and Defense</h2>

      <div class="section">
        <h3>Attack (choose 1)</h3>
        <label><input type="radio" name="attack" value="head"> Head</label><br>
        <label><input type="radio" name="attack" value="chest"> Chest</label><br>
        <label><input type="radio" name="attack" value="arms"> Arms</label><br>
        <label><input type="radio" name="attack" value="legs"> Legs</label><br>
        <label><input type="radio" name="attack" value="back"> Back</label><br>
      </div>

      <div class="section">
        <h3>Defense (choose 2)</h3>
        <label><input type="checkbox" name="defense" value="head"> Head</label><br>
        <label><input type="checkbox" name="defense" value="chest"> Chest</label><br>
        <label><input type="checkbox" name="defense" value="arms"> Arms</label><br>
        <label><input type="checkbox" name="defense" value="legs"> Legs</label><br>
        <label><input type="checkbox" name="defense" value="back"> Back</label><br>
      </div>

      <button id="fight-btn" disabled>Attack!</button>
    </div>

    <div class="Enemy">
      <h3 id="enemy-name">Enemy</h3>
      <img id="enemyAvatar" class="enemy-img" src="../images/monsters/monster1.png" alt="Enemy picture">
      <div class="health-bar">
        <div id="enemy-health" class="health-fill"></div>
      </div>
      <p id="enemy-hp-text">100 / 100</p>
    </div>

  </div>

  <div id="battle-log" style="max-height:250px; overflow-y:auto; border:1px solid #444; padding:10px; margin:20px;">
    <h3>Battle Log</h3>
  </div>
<script>
const fightBtn = document.getElementById("fight-btn");
const attackInputs = document.querySelectorAll("input[name='attack']");
const defenseInputs = document.querySelectorAll("input[name='defense']");
const logContainer = document.getElementById("battle-log");

// ----------------------------
// Validate selection
// ----------------------------
function validateSelection() {
  const attackChosen = Array.from(attackInputs).some(r => r.checked);
  const defenseChosen = Array.from(defenseInputs).filter(c => c.checked).length === 2;
  fightBtn.disabled = !(attackChosen && defenseChosen);
}

attackInputs.forEach(input => input.addEventListener("change", validateSelection));
defenseInputs.forEach(input => input.addEventListener("change", validateSelection));

// ----------------------------
// Player and enemy setup
// ----------------------------
const player = {
  name: localStorage.getItem("playerName") || "Player",
  avatar: localStorage.getItem("playerAvatar") || "../images/avatar1.png",
  hp: 120,
  maxHp: 120,
  damage: 20,
  critChance: 0.25,
  critMultiplier: 1.5
};

const enemies = [
  {
    name: "Big Sniff",
    img: "../images/monsters/monster1.jpg",
    hp: 100,
    maxHp: 100,
    damage: 15,
    critChance: 0.2,
    critMultiplier: 1.5,
    attackCount: 1,
    defenseCount: 3
  },
  {
    name: "Jellybelly",
    img: "../images/monsters/monster2.jpg",
    hp: 110,
    maxHp: 110,
    damage: 10,
    critChance: 0.3,
    critMultiplier: 1.5,
    attackCount: 2,
    defenseCount: 1
  },
  {
    name: "Chompchomp",
    img: "../images/monsters/monster3.jpg",
    hp: 140,
    maxHp: 140,
    damage: 18,
    critChance: 0.15,
    critMultiplier: 1.5,
    attackCount: 1,
    defenseCount: 2
  }
];

// Random enemy
const enemy = enemies[Math.floor(Math.random() * enemies.length)];

document.getElementById("enemy-name").textContent = enemy.name;
document.getElementById("enemyAvatar").src = enemy.img;
document.getElementById("player-name").textContent = player.name;
document.getElementById("currentAvatar").src = player.avatar;

// ----------------------------
// Update health bars
// ----------------------------
function updateHealthBars() {
  const playerHealthFill = document.getElementById("player-health");
  const enemyHealthFill = document.getElementById("enemy-health");

  playerHealthFill.style.width = (player.hp / player.maxHp * 100) + "%";
  enemyHealthFill.style.width = (enemy.hp / enemy.maxHp * 100) + "%";

  document.getElementById("player-hp-text").textContent = `${player.hp} / ${player.maxHp}`;
  document.getElementById("enemy-hp-text").textContent = `${enemy.hp} / ${enemy.maxHp}`;
}

updateHealthBars();

// ----------------------------
// Battle log
// ----------------------------
function addLog(message) {
  const entry = document.createElement("p");
  entry.innerHTML = message;
  logContainer.appendChild(entry);
  logContainer.scrollTop = logContainer.scrollHeight;
}

// ----------------------------
// Fight logic
// ----------------------------
const zones = ["head", "chest", "arms", "legs", "back"];

function randomZones(count) {
  let shuffled = [...zones].sort(() => 0.5 - Math.random());
  return shuffled.slice(0, count);
}

function calculateAttack(attacker, defender, attackZones, defenseZones) {
  attackZones.forEach(zone => {
    let isCrit = Math.random() < attacker.critChance;
    let baseDamage = attacker.damage;
    let dmg = isCrit ? Math.round(baseDamage * attacker.critMultiplier) : baseDamage;

    if (defenseZones.includes(zone)) {
      if (isCrit) {
        defender.hp -= dmg;
        addLog(`<b>${attacker.name}</b> landed a <span style="color:red">CRITICAL</span> hit on <span style="color:orange">${zone}</span> through the block and dealt <span style="color:red">${dmg}</span> damage!`);
      } else {
        addLog(`<b>${attacker.name}</b> attacked <b>${defender.name}</b> in the <span style="color:orange">${zone}</span>, but it was <span style="color:blue">blocked</span>.`);
      }
    } else {
      defender.hp -= dmg;
      addLog(`<b>${attacker.name}</b> attacked <b>${defender.name}</b> in the <span style="color:orange">${zone}</span> and dealt <span style="color:red">${dmg}</span> damage.`);
    }
  });

  if (defender.hp < 0) defender.hp = 0;
}

// ----------------------------
// Attack button
// ----------------------------
fightBtn.addEventListener("click", () => {
  // Player selection
  const playerAttack = Array.from(attackInputs).find(r => r.checked).value;
  const playerDefense = Array.from(defenseInputs).filter(c => c.checked).map(c => c.value);

  // Enemy random choices
  const enemyAttack = randomZones(enemy.attackCount);
  const enemyDefense = randomZones(enemy.defenseCount);

  // Player attacks
  calculateAttack(player, enemy, [playerAttack], enemyDefense);

  // Enemy attacks
  calculateAttack(enemy, player, enemyAttack, playerDefense);

  updateHealthBars();

  // -----------------------------
  // Check victory and save stats
  // -----------------------------
  let wins = parseInt(localStorage.getItem("wins")) || 0;
  let losses = parseInt(localStorage.getItem("losses")) || 0;

  if (player.hp <= 0 && enemy.hp <= 0) {
    addLog(`<b>Draw!</b> Both fighters are down.`);
    fightBtn.disabled = true;
  } else if (enemy.hp <= 0) {
    addLog(`<b>${player.name}</b> won the fight!`);
    wins += 1;
    localStorage.setItem("wins", wins);
    fightBtn.disabled = true;
  } else if (player.hp <= 0) {
    addLog(`<b>${enemy.name}</b> won the fight!`);
    losses += 1;
    localStorage.setItem("losses", losses);
    fightBtn.disabled = true;
  }
});

</script>
</body>
</html>
